# Data Contracts for E-Commerce Data Storytelling
# Defines expected schemas, validation rules, and data quality thresholds

version: "1.0.0"
last_updated: "2026-01-05"

# =============================================================================
# RAW DATA CONTRACT - UK Retail Transactions
# =============================================================================

raw_data:
  source_name: "uk_retail_transactions"
  description: "Transactional data from UK-based online retail company"
  format: "CSV"
  encoding: "UTF-8"
  
  schema:
    InvoiceNo:
      type: "string"
      nullable: false
      description: "Unique transaction identifier (6-digit number or starts with 'C' for cancellations)"
      validation:
        pattern: "^[C]?[0-9]{6}$"
      examples: ["536365", "C536366"]
      
    InvoiceDate:
      type: "datetime"
      nullable: false
      description: "Transaction timestamp"
      format: "%Y-%m-%d %H:%M:%S"
      validation:
        min_date: "2010-01-01"
        max_date: "2026-12-31"
      
    StockCode:
      type: "string"
      nullable: false
      description: "Product identifier"
      validation:
        max_length: 20
      notes: "May contain alphanumeric codes; some special codes exist (e.g., 'POST', 'DOT')"
      
    Description:
      type: "string"
      nullable: true  # Some products may have missing descriptions
      description: "Product description"
      validation:
        max_length: 500
        
    Quantity:
      type: "integer"
      nullable: false
      description: "Number of units (negative values indicate returns/cancellations)"
      validation:
        min_value: -10000  # Allow for bulk returns
        max_value: 10000
      business_rules:
        - "Negative quantities must correspond to invoices starting with 'C'"
        
    UnitPrice:
      type: "float"
      nullable: false
      description: "Price per unit in GBP"
      validation:
        min_value: 0.0
        max_value: 10000.0
      business_rules:
        - "Zero prices may indicate promotional items or data quality issues"
        
    CustomerID:
      type: "string"  # Stored as string to handle various formats
      nullable: true   # Some transactions lack customer ID
      description: "Unique customer identifier"
      validation:
        pattern: "^[0-9]{5}$"
      notes: "Null values represent guest checkouts or missing data"
      
    Country:
      type: "string"
      nullable: false
      description: "Customer's country"
      validation:
        allowed_values: "ISO country names"
      examples: ["United Kingdom", "Germany", "France", "EIRE"]

# =============================================================================
# DATA QUALITY RULES
# =============================================================================

data_quality:
  completeness:
    InvoiceNo:
      missing_threshold: 0.0  # Cannot be missing
      uniqueness_check: false  # Duplicates allowed (multiple items per invoice)
      
    InvoiceDate:
      missing_threshold: 0.0
      monotonicity: "non-decreasing"  # Dates should be in order (approximately)
      
    StockCode:
      missing_threshold: 0.0
      
    Description:
      missing_threshold: 0.05  # Allow up to 5% missing
      
    Quantity:
      missing_threshold: 0.0
      outlier_detection: "IQR"  # Flag extreme quantities
      
    UnitPrice:
      missing_threshold: 0.0
      zero_threshold: 0.02  # Allow up to 2% zero prices
      
    CustomerID:
      missing_threshold: 0.25  # Allow up to 25% guest checkouts
      
    Country:
      missing_threshold: 0.0
      
  consistency:
    rules:
      - name: "cancellation_quantity_match"
        description: "Cancellation invoices (starting with 'C') must have negative quantities"
        check: "IF InvoiceNo LIKE 'C%' THEN Quantity < 0"
        
      - name: "positive_price"
        description: "Unit prices must be non-negative"
        check: "UnitPrice >= 0"
        
      - name: "valid_transaction_value"
        description: "Transaction value (Quantity * UnitPrice) must be reasonable"
        check: "ABS(Quantity * UnitPrice) < 100000"
        
      - name: "future_date_check"
        description: "Invoice dates cannot be in the future"
        check: "InvoiceDate <= CURRENT_DATE"
        
  freshness:
    max_delay: "24 hours"
    expected_update_frequency: "daily"

# =============================================================================
# PROCESSED DATA CONTRACTS
# =============================================================================

processed_data:
  daily_kpis:
    description: "Daily aggregated KPI values"
    schema:
      date:
        type: "date"
        nullable: false
        primary_key: true
        
      kpi_name:
        type: "string"
        nullable: false
        primary_key: true
        allowed_values: "from config/kpis.yaml"
        
      kpi_value:
        type: "float"
        nullable: false
        
      confidence_score:
        type: "float"
        nullable: true
        range: [0.0, 1.0]
        
      calculation_timestamp:
        type: "datetime"
        nullable: false
        
      data_completeness:
        type: "float"
        range: [0.0, 1.0]
        description: "Percentage of expected data present"
        
  insights:
    description: "Detected insights with explanations"
    schema:
      insight_id:
        type: "string"
        nullable: false
        primary_key: true
        format: "UUID"
        
      detection_date:
        type: "datetime"
        nullable: false
        
      kpi_name:
        type: "string"
        nullable: false
        
      insight_type:
        type: "string"
        nullable: false
        allowed_values: ["anomaly", "trend_break", "pattern_change"]
        
      severity:
        type: "string"
        nullable: false
        allowed_values: ["low", "medium", "high", "critical"]
        
      confidence_score:
        type: "float"
        nullable: false
        range: [0.0, 1.0]
        
      explanation:
        type: "string"
        nullable: false
        description: "Human-readable explanation of the insight"
        
      root_cause:
        type: "json"
        nullable: true
        description: "Structured root cause analysis results"
        
      narrative:
        type: "string"
        nullable: true
        description: "LLM-generated executive summary"
        
      status:
        type: "string"
        nullable: false
        allowed_values: ["pending", "approved", "rejected", "archived"]
        default: "pending"
        
      approved_by:
        type: "string"
        nullable: true
        
      approval_timestamp:
        type: "datetime"
        nullable: true

# =============================================================================
# VALIDATION THRESHOLDS
# =============================================================================

validation_thresholds:
  overall_quality_score:
    minimum: 0.95  # Pipeline fails if data quality < 95%
    warning: 0.98  # Warn if quality < 98%
    
  row_count:
    minimum_daily: 100  # Expect at least 100 transactions per day
    warning_daily: 500
    
  temporal_gaps:
    max_gap_days: 7  # Flag if no data for 7+ days
    
  duplicate_detection:
    max_duplicate_rate: 0.01  # Allow up to 1% duplicates

# =============================================================================
# DATA LINEAGE TRACKING
# =============================================================================

lineage:
  source_system: "uk_retail_erp"
  extraction_method: "CSV export"
  transformation_steps:
    - "Remove duplicate transactions"
    - "Validate schema"
    - "Enrich with derived fields (TransactionValue, IsReturn, etc.)"
    - "Aggregate to KPI level"
  
  derived_fields:
    TransactionValue:
      formula: "Quantity * UnitPrice"
      type: "float"
      
    IsReturn:
      formula: "InvoiceNo LIKE 'C%' OR Quantity < 0"
      type: "boolean"
      
    DayOfWeek:
      formula: "EXTRACT(DAYOFWEEK FROM InvoiceDate)"
      type: "string"
      
    HourOfDay:
      formula: "EXTRACT(HOUR FROM InvoiceDate)"
      type: "integer"
      
    IsInternational:
      formula: "Country != 'United Kingdom'"
      type: "boolean"

# =============================================================================
# ERROR HANDLING
# =============================================================================

error_handling:
  on_validation_failure:
    action: "log_and_continue"  # Options: fail, skip_row, log_and_continue
    notification: true
    
  on_quality_threshold_breach:
    action: "fail"
    notification: true
    escalation: "data_team@company.com"
    
  on_schema_mismatch:
    action: "fail"
    notification: true
    
  logging:
    level: "INFO"
    format: "json"
    retention_days: 90